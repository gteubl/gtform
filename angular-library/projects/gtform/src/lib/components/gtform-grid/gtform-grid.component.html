<div [style.height]="gridHeight" class="form-grid">
  <div *ngIf="showHeader" class="table-header">
    <input (input)="applyFilter()"
           *ngIf="headerConfig.showFilter"
           [(ngModel)]="magicFilter"
           placeholder="Pesquisar nesta lista"
           type="text"
    >
    <form-button-icon (btnClick)="applyFilter()"
                      (click)="opmColumnsToFilter.toggle($event)"
                      *ngIf="headerConfig.showFilter"
                      icon="filter_alt"
                      pTooltip="Filtrar colunas"
    ></form-button-icon>
    <p-overlayPanel #opmColumnsToFilter>
      <div *ngFor="let column of gridColumns" class="action-item">
        <ng-container *ngIf="!column.filterNotAllowed">
          <form-input-checkbox (change)="onColumnFilterChange(column)"
                               (click)="$event.stopPropagation()"
                               [checked]="shouldFilter(column)"
          ></form-input-checkbox>
          <span>{{ column.headerText }}</span>
        </ng-container>
      </div>
    </p-overlayPanel>
    <ng-container *ngFor="let actionButton of headerConfig.actionsButtons">
      <form-button-icon (btnClick)="actionBtnClicked(actionButton)"
                        [disabled]="actionButton.disabled ?? false"
                        [icon]="actionButton.icon"
                        [pTooltip]="actionButton.tooltip ?? ''"
      ></form-button-icon>
    </ng-container>
    <ng-container *ngIf="headerConfig.moreActionsButtons">
      <ng-container *ngFor="let moreActionButton of  headerConfig.moreActionsButtons">
        <form-button-icon (click)="opMoreAction.toggle($event)" icon="more_vert"></form-button-icon>
        <p-overlayPanel #opMoreAction>
          <div (click)="onMoreHeaderActionClick(action)"
               *ngFor="let action of moreActionButton.moreActions"
               class="action-item {{ action.disabled ? 'disabled' : '' }}"
          >
            <form-icon [disabled]="action.disabled ?? false" [icon]="action.icon"></form-icon>
            <span>{{ action.tooltip }}</span>
          </div>
        </p-overlayPanel>
      </ng-container>
    </ng-container>
  </div>
  <div class="table-scroll">
    <div *ngIf="isLoading$ | async" class="grid-spinner">
      <form-spinner></form-spinner>
    </div>
    <table>
      <thead class="top-border">
      <tr (cdkDropListDropped)="onDrop($event)" cdkDropList cdkDropListOrientation="horizontal">
        <ng-container *ngIf="showNumber">
          <th class="fixed-index"></th>
        </ng-container>
        <ng-container *ngIf="isSelectable">
          <th style="width: 3em">
            <form-input-checkbox (change)="onClickRowSelectable()" [(ngModel)]="shouldSelectAll"></form-input-checkbox>
          </th>
        </ng-container>
        <th (click)="onSort(column)"
            *ngFor="let column of gridColumns$ | async"
            [cdkDragDisabled]="!allowDrag"
            [formResizable]="column.resizable ?? false"
            [style.width]="column.width ? column.width : 'auto'"
            cdkDrag
        >
          <div class="default-header">
            <span class="header-text"> {{ column.headerText }}</span>
            <span [ngClass]="(sortColumn === column.propertyName) ? 'visible' : 'hidden'" class="header-direction">
          <form-icon [icon]="sortDirection === 'asc' ? 'expand_less' : 'expand_more'"></form-icon>
</span> <span class="resize-handle"></span>
          </div>
        </th>
        <ng-container *ngIf="showRowsActions">
          <th class="action-column">
            <form-button-icon *ngIf="isSelectable" icon="more_vert"></form-button-icon>
          </th>
        </ng-container>
      </tr>
      </thead>
      <tbody>
      <tr (click)="setCurrentRow(row)"
          (contextmenu)="openContextMenu($event, row)"
          *ngFor="let row of dataArray | async, let idx = index "
          [ngClass]="{'row-hover': rowHover, 'active': row == activeRow && enableActiveRow}"
          class="row-hover"
      >
        <ng-container *ngIf="showNumber">
          <td class="fixed-index"> {{ idx + 1 }}</td>
        </ng-container>
        <ng-container *ngIf="isSelectable">
          <td>
            <form-input-checkbox (change)="onChangeRowSelected(row)" [(ngModel)]="row.selected"></form-input-checkbox>
          </td>
        </ng-container>
        <td (click)="onClickRow(row, cell)" *ngFor="let cell of row.cells" [ngClass]="{'wrap-text': cell.wrapText == true}" class="cell">
          <ng-container [ngSwitch]="cell.dataType">
            <ng-container *ngSwitchCase="GridDataType.DATE">
              {{ cell.value | castData:cell.dataType | date: 'dd/MM/yyyy' }}
            </ng-container>
            <ng-container *ngSwitchCase="GridDataType.DATETIME">
              {{ cell.value |  castData:cell.dataType | date: 'dd/MM/yyyy HH:mm' }}
            </ng-container>
            <ng-container *ngSwitchCase="GridDataType.CURRENCY">
              {{ cell.value | castData:cell.dataType | currency: 'BRL' }}
            </ng-container>
            <ng-container *ngSwitchCase="GridDataType.PERCENTAGE">
              {{ cell.value | castData:cell.dataType | percent }}
            </ng-container>
            <ng-container *ngSwitchCase="GridDataType.CPFCNPJ">
              {{ cell.value | castData:cell.dataType | formatCpfCnpj }}
            </ng-container>
            <ng-container *ngSwitchCase="GridDataType.CHOICEOPTION">
              {{ (cell.value) | castData:cell.dataType | formatChoiceOption }}
            </ng-container>
            <ng-container *ngSwitchCase="GridDataType.CUSTOMTEMPLATE">
              <ng-template [ngTemplateOutletContext]="{$implicit: row.rawData}" [ngTemplateOutlet]="cell.template!"></ng-template>
            </ng-container>
            <ng-container *ngSwitchCase="GridDataType.BOOLEAN">
              <form-input-checkbox [checked]="cell.value | castData:cell.dataType" [disabled]="true"></form-input-checkbox>
            </ng-container>
            <ng-container *ngSwitchCase="GridDataType.ARRAY">
              <span>[</span>
              <ng-container *ngFor="let item of cell.value | castData:cell.dataType; last as isLast ">
                <span>{{ item }}</span> <span *ngIf="!isLast">, </span>
              </ng-container>
              <span>]</span>
            </ng-container>
            <ng-container *ngSwitchDefault>
              {{ cell.value }}
            </ng-container>
          </ng-container>
        </td>
        <ng-container *ngIf="showRowsActions">
          <td class="action-column">
            <form-button-icon (click)="opRowAction.toggle($event); setCurrentRow(row)" icon="more_vert"></form-button-icon>
            <p-overlayPanel #opRowAction>
              <div (click)="onActionClick(action)"
                   *ngFor="let action of gridRowActions"
                   class="action-item {{ action.disabled ? 'disabled' : '' }}"
              >
                <form-icon [disabled]="action.disabled ?? false" [icon]="action.icon"></form-icon>
                <span>{{ action.text }}</span>
              </div>
            </p-overlayPanel>
          </td>
        </ng-container>
      </tr>
      </tbody>
    </table>
  </div>
  <div *ngIf="showFooter" class="table-footer">
    <div>
      Pagina: {{ (gridFooterInfo | async)?.page }} de {{ (gridFooterInfo | async)?.totalPages }}
    </div>
    <div class="footer-pagination">
      <form-button-icon (btnClick)="onFirstPage()" [disabled]="(gridFooterInfo | async)?.page === 1" icon="first_page"></form-button-icon>
      <form-button-icon (btnClick)="onPreviousPage()"
                        [disabled]="(gridFooterInfo | async)?.page === 1"
                        icon="chevron_left"
      ></form-button-icon>
      <form-button-icon (btnClick)="onNextPage()"
                        [disabled]="(gridFooterInfo | async)?.page === (gridFooterInfo | async)?.totalPages"
                        icon="chevron_right"
      ></form-button-icon>
      <form-button-icon (btnClick)="onLastPage()"
                        [disabled]="(gridFooterInfo | async)?.page === (gridFooterInfo | async)?.totalPages"
                        icon="last_page"
      ></form-button-icon>
    </div>
    <div class="page-size-options">
      <ng-container *ngFor="let page of (gridFooterInfo | async)?.pageSizeOptions ">
        <span (click)="changePageSize(page)"
              [ngClass]="{'active': page == (gridFooterInfo | async)?.pageSize}"
              class="page-link"
        >{{ page }}</span>
      </ng-container>
    </div>
    <div class="footer-total">
      Total: {{ (gridFooterInfo | async)?.totalItems }}
    </div>
  </div>
</div>
